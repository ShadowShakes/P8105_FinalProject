---
title: "Data Preprocessing"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

# Data Source

## NYC Open Data

NYC Open Data is an online portal that makes the public data generated by various New York City agencies and other City organizations available for public use. As part of an initiative to improve the accessibility, transparency, and accountability of City government, NYC Open Data offers access to a repository of government-produced, searchable data sets available for download.

### NYPD Complaint Data Historic

This dataset includes all valid felony, misdemeanor, and violation crimes reported to the New York City Police Department (NYPD) from 2006 to 2022. We think the whole dataset is too large, so we only pick the data from 2016 to 2022, and slice it by year.

# Data cleaning

We obtain the complaint data for each year from 2016 to 2022 as mentioned above. According to the attachment, there are 34 columns and we want to select those meaningful and valuable.

### Column Information

* `CMPLNT_NUM`: Randomly generated persistent ID for each complaint (numeric)
* `ADDR_PCT_CD`: The precinct in which the incident occurred (categorical factor)
* `BORO_NM`: The name of the borough in which the incident occurred (categorical factor)
* `CMPLNT_FR_DT`: Exact date of occurrence for the reported event (character)
* `CMPLNT_FR_TM`: Exact time of occurrence for the reported event (numeric)
* `CMPLNT_TO_DT`: Ending date of occurrence for the reported event (character)
* `CMPLNT_TO_TM`: Ending time of occurrence for the reported event (numeric)
* `CRM_ATPT_CPTD_CD`: Indicator of whether crime was successfully completed or attempted (binary)
* `HADEVELOPT`: Name of NYCHA housing development of occurrence, if applicable (character)
* `HOUSING_PSA`: Development Level Code (numeric)
* `JURISDICTION_CODE`: Jurisdiction responsible for incident (categorical factor)
* `JURIS_DESC`: Description of the jurisdiction code (categorical factor)
* `KY_CD`: Three digit offense classification code (categorical factor)
* `LAW_CAT_CD`: Level of offense: felony, misdemeanor, violation (categorical factor)
* `LOC_OF_OCCUR_DESC`: Specific location of occurrence in or around the premises (categorical factor)
* `OFNS_DESC`: Description of offense corresponding with key code (categorical factor)
* `PARKS_NM`: Name of NYC park, playground or greenspace of occurrence, if applicable (categorical factor)
* `PATROL_BORO`: The name of the patrol borough in which the incident occurred (categorical factor)
* `PD_CD`: Three digit internal classification code (categorical factor)
* `PD_DESC`: Description of internal classification corresponding with PD code (categorical factor)
* `PREM_TYP_DESC`: Specific description of premises (character)
* `RPT_DT`: Date event was reported to police (character)
* `STATION_NAME`: Transit station name (character)
* `SUSP_AGE_GROUP`: Suspect’s Age Group (categorical factor)
* `SUSP_RACE`: Suspect’s Race Description (categorical factor)
* `SUSP_SEX`: Suspect’s Sex Description (categorical factor)
* `TRANSIT_DISTRICT`: Transit district in which the offense occurred (categorical factor) 
* `VIC_AGE_GROUP`: Victim’s Age Group (categorical factor)
* `VIC_RACE`: Victim’s Race Description (categorical factor)
* `VIC_SEX`: Victim’s Sex Description (categorical factor)
* `X_COORD_CD`: X-coordinate for New York State Plane Coordinate System (numeric)
* `Y_COORD_CD`: Y-coordinate for New York State Plane Coordinate System (numeric)
* `Latitude`: Midblock Latitude coordinate for Global Coordinate System (numeric)
* `Longitude`: Midblock Longitude coordinate for Global Coordinate System (numeric)

We want to get rid of redundant variables or variables with little information, and only keep those important.

After a decision, we retained `CMPLNT_NUM`, `ADDR_PCT_CD`, `BORO_NM`, `CMPLNT_FR_DT`, `CMPLNT_FR_TM`, `CRM_ATPT_CPTD_CD`, `JURIS_DESC`, `LAW_CAT_CD`, `OFNS_DESC`, `SUSP_AGE_GROUP`, `SUSP_RACE`, `SUSP_SEX`, `VIC_AGE_GROUP`, `VIC_RACE`, `VIC_SEX`, `Latitude`, and `Longitude`.

```{r}
files_name = list.files("data/")

cleaning_data = function(filename){
  
  path = str_c("data/", filename)
  
  clean_df = 
    read_csv(path) %>% 
    select(CMPLNT_NUM, ADDR_PCT_CD, BORO_NM, CMPLNT_FR_DT, CMPLNT_FR_TM, CRM_ATPT_CPTD_CD, JURIS_DESC, LAW_CAT_CD, OFNS_DESC, SUSP_AGE_GROUP, SUSP_RACE, SUSP_SEX, VIC_AGE_GROUP, VIC_RACE, VIC_SEX, Latitude, Longitude) %>% 
    janitor::clean_names() %>% 
    mutate(
      susp_age_group = ifelse(susp_age_group %in% c("<18", "18-24", "25-44", "45-64", "65+"), susp_age_group, "UNKNOWN"),
      susp_race = ifelse(is.na(susp_race), "UNKNOWN", susp_race),
      susp_sex = ifelse(susp_sex %in% c("F", "M"), susp_sex, "U"),
      vic_age_group = ifelse(vic_age_group %in% c("<18", "18-24", "25-44", "45-64", "65+"), vic_age_group, "UNKNOWN"),
      vic_race = ifelse(is.na(vic_race), "UNKNOWN", vic_race),
      vic_sex = ifelse(vic_sex %in% c("F", "M"), vic_sex, "U"),
      addr_pct_cd = factor(addr_pct_cd),
      boro_nm = factor(boro_nm),
      crm_atpt_cptd_cd = factor(crm_atpt_cptd_cd),
      juris_desc = factor(juris_desc),
      law_cat_cd = factor(law_cat_cd),
      ofns_desc = factor(ofns_desc),
      susp_age_group = factor(susp_age_group),
      susp_race = factor(susp_race),
      susp_sex = factor(susp_sex),
      vic_age_group = factor(vic_age_group),
      vic_race = factor(vic_race),
      vic_sex = factor(vic_sex)
    ) 
  
  exporting_path = str_c("data/cleaned_", filename)
  
  write_csv(clean_df, file = exporting_path)
  
}

map(files_name, cleaning_data)
```
